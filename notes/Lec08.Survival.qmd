---
title: "Introduction to Survival Analysis"
subtitle: "Lecture 08"
name: Lec08.Survival.qmd
---

```{r}
#| echo: false
library(rms)
library(ggplot2)
library(knitr)
library(dplyr)
library(survival)
library(ggplot2)
library(tibble)
library(survminer)
library(dplyr)
library(flexsurv)
library(eha)
tryCatch(source('pander_registry.R'), error = function(e) invisible(e))
```

## Acknowledgments

Parts of the introductory material are borrowed from Emily Zabor's [introduction to survival analysis in R](https://www.emilyzabor.com/tutorials/survival_analysis_in_r_tutorial.html).

## Background

In logistic regression, we were interested in studying how risk factors were associated with presence or absence of disease. Sometimes, though, we are interested in how a risk factor or treatment affects time to disease or some other event. Or we may have study dropout, and therefore subjects who we are not sure if they had disease or not. In these cases, logistic regression is not appropriate.

Survival analysis is used to analyze data in which the time until the event is of interest. The response is often referred to as a failure time, survival time, or event time.

### Examples

-   Time from randomization until cardiovascular death after some treatment intervention

-   Time from diagnosis until tumor recurrence

-   Time from diagnosis until AIDS for HIV patients

-   Time from production until a machine part fails

-   Note that there needs to be a clearly defined starting and ending point

### The survival time response

-   Usually continuous
-   May be incompletely determined for some subjects
    -   i.e. For some subjects we may know that their survival time was at least equal to some time t. Whereas, for other subjects, we will know their exact time of event.
-   Incompletely observed responses are *censored*
-   Time is always $>0$

### Analysis issues

-   If there is no censoring, standard regression procedures could be used
-   However, these may be inadequate because
    -   Time to event is restricted to be positive and has a skewed distribution.
    -   The probability of surviving past a certain point in time may be of more interest than the expected time of event. Linear regression models means.
    -   A multiplicative model for the hazard may be a better fit
    -   May desire an interpretation that is similar to a relative risk

### Censoring

Censoring is present when we have some information about a subject's event time, but we don't know the exact event time. For the analysis methods we will discuss to be valid, censoring mechanism must be independent of the survival mechanism.

There are generally three reasons why censoring might occur:

-   A subject does not experience the event before the study ends
-   A person is lost to follow-up during the study period
-   A person withdraws from the study

These are all examples of right-censoring.

![Trial Anatomy](figures/trial_anatomy.png)

> RICH JT, NEELY JG, PANIELLO RC, VOELKER CCJ, NUSSENBAUM B, WANG EW. A PRACTICAL GUIDE TO UNDERSTANDING KAPLAN-MEIER CURVES. Otolaryngology head and neck surgery: official journal of American Academy of Otolaryngology Head and Neck Surgery. 2010;143(3):331-336. doi:10.1016/j.otohns.2010.05.007.

To illustrate the impact of censoring, suppose we have the following data:

```{r swimmer, echo = FALSE}
# make fake data
set.seed(20180809)
fkdt <- tibble(Subject = as.factor(1:10), 
                   Years = sample(4:20, 10, replace = T),
                   censor = sample(c("Censor", rep("Event", 2)), 10, 
                                   replace = T)) 

# plot with shapes to indicate censoring or event
ggplot(fkdt, aes(Subject, Years)) + 
    geom_bar(stat = "identity", width = 0.5) + 
    geom_point(data = fkdt, 
               aes(Subject, Years, color = censor, shape = censor), 
               size = 6) +
    coord_flip() +
    theme_minimal() + 
    theme(legend.title = element_blank(),
          legend.position = "bottom")
```

How would we compute the proportion who are event-free at 10 years?

-   Subjects 6 and 7 were **event-free at 10 years**.
-   Subjects 2, 9, and 10 had the **event before 10 years**.
-   Subjects 1, 3, 4, 5, and 8 were **censored before 10 years**, so we don't know whether they had the event or not at 10 years. But we know something about them - that they were each followed for a certain amount of time without the event of interest prior to being censored.

*Survival analysis techniques provide a way to appropriately account for censored patients in the analysis.*

### Types of right-censoring

-   Fixed type I censoring occurs when a study is designed to end after C years of follow-up. In this case, everyone who does not have an event observed during the course of the study is censored at C years.
-   In random type I censoring, the study is designed to end after C years, but censored subjects do not all have the same censoring time. This is the main type of right-censoring we will be concerned with.
-   In type II censoring, a study ends when there is a pre- specified number of events.

Regardless of the type of censoring, we must assume that it is non-informative about the event; that is, the censoring is caused by something other than the impending failure.

### Terminology and notation

-   $T$ denotes the response variable, $T > 0$
-   The survival function is

$$
S(t) = \textrm{Pr}(T > t) = 1− F(t)
$$

```{r}
#| fig-cap: Example survival function.  Survival is 1 at time 0 and decreases over time.
plot(function(t) exp(-2*t), 0, 2, ylab="Survival", xlab="Time (years)")
```

-   All subjects are at risk (and event free) at time 0. Thus, the survival estimate at 0 is always 1
-   Survival decreases over time. If we observe for a long enough period of time, survival eventually decreases to 0.
-   The survival function gives the probability that a subject will survive past time t.
-   Specifically, as t ranges from 0 to $\infty$, the survival function has the following properties
    -   It is non-increasing

    -   At time t = 0, S(t) = 1. In other words, the probability of surviving past time 0 is 1.

    -   At time $t = \infty$, $S(t) = S(\infty) = 0$. As time goes to infinity, the survival curve goes to 0.
-   In theory, the survival function is smooth. In practice, we observe events on a discrete time scale (days, weeks, etc.)

#### Hazard, cumulative hazard, and survival

-   The hazard function, h(t), is the instantaneous rate at which events occur, given no previous events. $$
    h(t) = \lim_{{\Delta t} \to 0} \frac{P(t \leq T < t + \Delta t | T \geq t)}{\Delta t}
    $$

-   $T$ is a random variable denoting the time until the event (for example, failure or death) occurs. The numerator in the fraction is the conditional probability that the event occurs in the small time interval $[t, t + Δt]$ given that it has not occurred before time $t$. The denominator $\Delta t$ is the length of this time interval. As $\Delta t$ goes to 0, this ratio gives the instantaneous rate of occurrence of the event at time $t$, which is the hazard function $h(t)$.

-   The cumulative hazard

$$
H(t) = \int_{0}^{t} h(u) du
$$

-   Here, h(u) is the hazard function and u is the variable of integration. This integral represents the accumulated risk of the event (for example, failure or death) over the time interval $[0, t]$.

-   The relationship between the survival function $S(t)$ and the cumulative hazard function $H(t)$

$$
S(t) = \exp(-H(t))
$$

-   Key point: Survival function, cumulative hazard function, and hazard function are interconnected. If we know any one of the functions $S(t)$, $H(t)$, or $h(t)$, we can derive the other two functions.

#### Outcome definition

-   To analyze survival data, we need to know the observed time $Y_i$ and the event indicator $\delta_i$. For subject $i$:

-   Observed time $Y_i = \min(T_i, C_i)$ where $T_i$ = event time and $C_i$ = censoring time

-   Event indicator $\delta_i$ = 1 if event observed (i.e. $T_i \leq C_i$), = 0 if censored (i.e. $T_i > C_i$)

## Non-parametric estimation of the survival curve

-   In theory the survival function is smooth; in practice we observe events on a discrete time scale.

-   The **survival probability** at a certain time, $S(t)$, is a conditional probability of surviving beyond that time, given that an individual has survived just prior to that time. The survival probability can be estimated as the number of patients who are alive without loss to follow-up at that time, divided by the number of patients who were alive just prior to that time.

-   The **Kaplan-Meier** estimate of survival probability at a given time is the product of these conditional probabilities up until that given time

$$
\hat{S}(t) = \prod_{i: t_i \leq t} (1 - \frac{d_i}{n_i})
$$

-   $\hat{S}(t)$ is the estimated survival function at time (t),
-   $t_i$ are the observed event times,
-   $d_i$ is the number of events (e.g. deaths) at time ($t_i$),
-   $n_i$ is the number of individuals known to have survived (are at risk) up to time ($t_i$).

### Example: The `lung` dataset

The `lung` dataset is available from the {survival} package. The data contain subjects with advanced lung cancer from the North Central Cancer Treatment Group. We will focus on the following variables throughout this tutorial:

-   time: Observed survival time in days
-   status: censoring status 1=censored, 2=dead
-   sex: 1=Male, 2=Female

*Note that the status is coded in a non-standard way in this dataset. Typically you will see 1=event, 0=censored*. Let's recode it to avoid confusion:

```{r}
lung <- 
  lung %>% 
  mutate(
    status = recode(status, `1` = 0, `2` = 1)
  )
```

Now we have:

-   time: Observed survival time in days
-   status: censoring status 0=censored, 1=dead
-   sex: 1=Male, 2=Female

Here are the first 6 observations:

```{r viewlung}
head(lung[, c("time", "status", "sex")])
```

*Note*: the `Surv()` function in the {survival} package accepts by default TRUE/FALSE, where TRUE is event and FALSE is censored; 1/0 where 1 is event and 0 is censored; or 2/1 where 2 is event and 1 is censored. **Please take care to ensure the event indicator is properly formatted.**

### Creating survival objects and curves

The Kaplan-Meier method is the most common way to estimate survival times and probabilities. It is a non-parametric approach that results in a step function, where there is a step down each time an event occurs.

The `Surv()` function from the {survival} package creates a survival object for use as the response in a model formula. There will be one entry for each subject that is the survival time, which is followed by a `+` if the subject was censored. Let's look at the first 10 observations:

```{r survfunc}
Surv(lung$time, lung$status)[1:10]
```

We see that subject 1 had an event at time 306 days, subject 2 had an event at time 455 days, subject 3 was censored at time 1010 days, etc.

The `survfit()` function creates survival curves using the Kaplan-Meier method based on a formula. Let's generate the overall survival curve for the entire cohort, assign it to object `s1`, and look at the structure using `str()`:

```{r lung_survfit}
s1 <- survfit(Surv(time, status) ~ 1, data = lung)
str(s1)
```

Some key components of this `survfit` object that will be used to create survival curves include:

-   `time`: the timepoints at which the curve has a step, i.e. at least one event occurred
-   `surv`: the estimate of survival at the corresponding `time`

### Kaplan-Meier estimates

::: {style="height:400px;overflow:auto;"}
```{r}
summary(s1)
```
:::

-   Applying the formula

$$
\hat{S}(t) = \prod_{i: t_i \leq t} (1 - \frac{d_i}{n_i})
$$

-   $S(0) = 1$

-   $S(5) = 1*(1-1/228) = 0.9956$

-   $S(11) = 1*(1-1/228)*(1-3/227) = 0.9825$

-   etc.

-   Number at risk is decrease by events or censored observations

-   Most early times are events, so number at risk is decreasing because of events. -- The first censored observation is at 92 days. Here, the risk set decreases by the number of events and number censored (find this time point in the table to verify yourself)

### Kaplan-Meier plot

```{r}
ggsurvplot(s1, data=lung, risk.table = TRUE)
```

-   Plot gives estimate of survival over time
-   Confidence interval is conditional on a given survival time (rather than being a confidence band for the entire survival curve)
-   Risk table gives the number of subjects at risk at specified time points

### Estimating $x$-year survival

One quantity often of interest in a survival analysis is the probability of surviving beyond a certain number of years, $x$.

For example, to estimate the probability of surviving to $1$ year, use `summary` with the `times` argument (*Note:* the `time` variable in the `lung` data is actually in days, so we need to use `times = 365.25`)

```{r 5yrest}
summary(survfit(Surv(time, status) ~ 1, data = lung), times = 365.25)
```

We find that the $1$-year probability of survival in this study is `r round(summary(survfit(Surv(time, status) ~ 1, data = lung), times = 365.25)$surv * 100)`%.

The associated lower and upper bounds of the 95% confidence interval are also displayed.

The $1$-year survival probability is the point on the y-axis that corresponds to $1$ year on the x-axis for the survival curve.

```{r, message = FALSE, echo = FALSE, fig.height = 5}
plot_main <- ggsurvplot(s1, data=lung, risk.table = TRUE)

plot1 <- 
  plot_main$plot + 
  geom_segment(x = 365.25, xend = 365.25, y = -0.05, yend = 0.4092416, 
               linewidth = 1.5) +
  geom_segment(x = 365.25, xend = -40, y = 0.4092416, yend = 0.4092416,
               linewidth = 1.5, 
               arrow = arrow(length = unit(0.2, "inches"))) 

plot1
```

What happens if you use a "naive" estimate? Here "naive" means that the patients who were censored prior to 1-year are considered event-free and included in the denominator.

`r table(lung$status[lung$time <= 365.25])[2]` of the `r nrow(lung)` patients in the `lung` data died by $1$ year so the "naive" estimate is calculated as:

$$\Big(1 - \frac{121}{228}\Big) \times 100 = 47\%$$ You get an **incorrect** estimate of the $1$-year probability of survival when you ignore the fact that `r table(lung$status[lung$time <= 365.25])[1]` patients were censored before $1$ year.

Recall the **correct** estimate of the $1$-year probability of survival, accounting for censoring using the Kaplan-Meier method, was `r round(summary(s1, times = 365.25)$surv * 100)`%.

Ignoring censoring leads to an **overestimate** of the overall survival probability. Imagine two studies, each with 228 subjects. There are 165 deaths in each study. Censoring is ignored in one , censoring is accounted for in the other. The censored subjects only contribute information for a portion of the follow-up time, and then fall out of the risk set, thus pulling down the cumulative probability of survival. Ignoring censoring erroneously treats patients who are censored as part of the risk set for the entire follow-up period.

```{r echo = FALSE, message = FALSE, warning = FALSE, fig.height = 6}
fakedata2 <- 
  lung %>% 
  mutate(
    time = ifelse(status == 1, time, 1022), 
    group = "Ignoring censoring") %>% 
  full_join(mutate(lung, group = "With censoring"))

fit.fake <- survfit(Surv(time, status) ~ group, data = fakedata2)

ggsurvplot(fit.fake, risk.table=TRUE) +
  labs(
    x = "Days",
    y = "Overall survival probability"
    )
```

### Estimating median survival time

Another quantity often of interest in a survival analysis is the average survival time, which we quantify using the median. Survival times are not expected to be normally distributed so the mean is not an appropriate summary.

We can obtain the median survival directly from the `survfit` object:

```{r}
survfit(Surv(time, status) ~ 1, data = lung)
```

We see the median survival time is `r round(summary(s1)$table["median"], 1)` days The lower and upper bounds of the 95% confidence interval are also displayed.

Median survival is the time corresponding to a survival probability of $0.5$:

```{r, message = FALSE, echo = FALSE, fig.height = 5}
plot2 <- 
  plot_main$plot +
  geom_segment(x = -45, xend = 310, y = 0.5, yend = 0.5,  linewidth = 1.5) +
  geom_segment(x = 310, xend = 310, y = 0.5, yend = -0.02, linewidth = 1.5, 
               arrow = arrow(length = unit(0.2, "inches")))

plot2
```

### Non-parametric test for comparing survival times between groups

-   The most common test for comparing survival by groups is the log-rank test

    -   At each event time, constructs a 2x2 table of observed events and number at risk for each group

    -   Compare observed to expected number of events under the null hypothesis that the event rates are the same in each group

    -   A Chi-squared test stratifying over all event times

    -   A test of the entire survival curve

-   We get the log-rank p-value using the `survdiff` function. For example, we can test whether there was a difference in survival time according to sex in the `lung` data:

```{r}
survdiff(Surv(time, status) ~ sex, data = lung)
```

-   We can also add the p-value to Kaplan-Meier plot by sex

```{r}
fit.sex <- survfit(Surv(time, status) ~ sex, data=lung)
ggsurvplot(fit.sex, data=lung, pval=TRUE)
```

There was a significant difference in overall survival according to sex in the `lung` data, with a p-value of p = `r round(1-pchisq(survdiff(Surv(time, status) ~ sex, data = lung)$chisq, 1),4)`.

## Semi-parametric regression (Cox proportional hazards model)

-   The preceding approach was very flexible in that it makes no parametric assumptions above the shape of the survival curve

-   This can work for well for categorical predictors and/or descriptive purposes

-   In a clinical trial where we have randomized to treatment groups (and presumably have minimized confounding), the Kaplan-Meier method and log-rank test can be the primary analysis method

-   Extensions are needed if we want to consider continuous predictors and multivariable models

-   Would be nice to maintain flexibility and have a readily interpret

-   Statistical methods

    -   Regression models we have studied to date are generally not valid for survival data

        -   Because of right censoring, survival time cannot be analyzed as a continuous outcome (e.g. linear regression)

        -   Because of unequal length of followup, survival (yes/no) cannot be analyzed using logistic regression

    -   In the presence of censored data, the usual descriptive statistics are not appropriate

        -   Sample mean, sample median, simple proportions, sample standard deviation should not be used

        -   Proper descriptives should be based on the Kaplan Meier estimates

    -   Specialized regression models are needed with censored data

-   (Cox) Proportional hazards model

    -   Considers the instantaneous risk of failure at each time among those subjects who have not failed

    -   The term "proportional hazards" assumes that the ratio of these instantaneous failure rates is constant in time between groups

    -   Proportional hazards (Cox) regression treats the survival distribution within a group semi-parametrically

        -   The baseline hazard is estimated without making any distributional assumptions

        -   The hazard ratio is the parameter of interest and is used to compare groups

### Proportional Hazards Regression

-   Looks at odds of choosing subjects relative to prevalence in the population

    -   Can be derived as estimating the odds ratio of an event at each time that an event occurs

    -   Proportional hazards model averages the odds ratio across all observed event times

    -   If the odds ratio is constant over time between two groups, such an average results in a precise estimate of the hazard ratio

-   Borrowing information

    -   Uses other groups to make estimates in groups with sparse data

    -   Borrows information across predictor groups

        -   Intuitively, 67 and 69 year olds would provide some relevant information about 68 year olds

    -   Also borrows information over time

        -   Relative risk for an event at each time is presumed to be the same under proportional hazards

### The simple PH regression model

-   Modeling the log hazard over time as a function of covariates $X$

-   "Baseline hazard" is unspecified. Baseline hazard is similar to an intercept

    | Model       | $\textrm{log}(\lambda(t | X_i)) = \textrm{log}(\lambda_{0}(t)) + \beta_1 \times X_i$ |
    |:-------------------------|:---------------------------------------------|
    | $X_i = 0$   | log hazard at $t$ is $\textrm{log}(\lambda_{0}(t))$                                  |
    | $X_i = x$   | log hazard at $t$ is $\textrm{log}(\lambda_{0}(t)) + \beta_1 \times x$               |
    | $X_i = x+1$ | log hazard at $t$ is $\textrm{log}(\lambda_{0}(t))+ \beta_1 \times x + \beta_1$      |

-   Model on the hazard scale is found by exponentiating parameters

    | Model       | $\lambda(t | X_i) = \lambda_{0}(t) \times e^{\beta_1 \times X_i}$                |
    |:-------------------------|:---------------------------------------------|
    | $X_i = 0$   | hazard at $t$ is $\lambda_{0}(t)$                                                |
    | $X_i = x$   | hazard at $t$ is $\lambda_{0}(t) \times e^{\beta_1 \times x}$                    |
    | $X_i = x+1$ | hazard at $t$ is $\lambda_{0}(t) \times e^{\beta_1 \times x} \times e^{\beta_1}$ |

-   Interpretation of the model

    -   No intercept

        -   Generally ignore the baseline hazard

    -   Slope parameter

        -   Hazard ratio found by exponentiating the slope from the PH regression: $\textrm{exp}(\beta_1)$

        -   Hazard ratio compared groups differing in the value of the predictor by 1 unit

-   Relationship to survival

    -   Hazard function determines the survival function

        |                   |                                                                                              |
        |:-------------------------|:---------------------------------------------|
        | Hazard            | $\lambda(t | X_i) = \lambda_{0}(t) \times e^{\beta_1 \times X_i}$                            |
        | Cumulative Hazard | $\Lambda(t | X_i) = \displaystyle\int^t_0 \lambda_{0}(u) \times e^{\beta_1 \times X_i} \ du$ |
        | Survival Function | $S(t | X_i) = e^{-\Lambda(t|X_i)} = [S_0(t)]^{e^{\beta_1 \times X_i}}$                       |

### Descriptive Plots

#### Hazard

```{r}
set.seed(55)
x <- seq(0,2*pi,by=0.1)
lambda0 <- (2*sin(x) + 4 + rnorm(length(x), 0, .2)) / 100
lambda0[1] <- 0
plot(x, lambda0, type='l', xlab="Time", ylab="Hazard", ylim=c(0,.1), main="Baseline Hazard Over Time", lwd=2)
legend("top", inset=0.05, lty=1, expression(lambda[0] (t)), lwd=2)
```

#### Cumulative hazard

```{r}
plot(x, cumsum(lambda0), type='l', xlab="Time", ylab="Cumulative Hazard", ylim=c(0,3), main="Baseline Cumulative Hazard over Time", lwd=2)
legend("top", inset=0.05, lty=1, expression(Lambda[0] (t) == integral(lambda[0] (u)*du, 0, t)), lwd=2)
```

#### Survival

```{r}
plot(x, exp(-cumsum(lambda0)), type='l', xlab="Time", ylab="Survival", ylim=c(0,1), main="Baseline Survival over Time", lwd=2)
legend("top", inset=0.05, lty=1, expression(exp(-Lambda[0] (t))), lwd=2)
```

#### Proportional hazards assumption

```{r}
lambda1 <- lambda0*1.5
plot(x, lambda0, type='l', xlab="Time", ylab="Hazard", ylim=c(0,.1), main="Proportional Hazards for Two Groups", lwd=2)
lines(x, lambda1, col="Red", lwd=2)
legend("topright", inset=0.05, lty=1, c(expression(lambda[0] (t)), expression(lambda[1] (t) == 1.5*lambda[0] (t))), lwd=2, col=c("Black","Red"))
```

#### Proportional hazards assumption on log scale

```{r}
plot(x, log(lambda0), type='l', xlab="Time", ylab="Log Hazard", ylim=c(-4.5,-2), main="Proportional Hazards for Two Groups, log scale", lwd=2)
lines(x, log(lambda1), col="Red", lwd=2)
legend("topright", inset=0.05, lty=1, c(expression(log(lambda[0] (t))), expression(log(lambda[1] (t)) == log(1.5) + log(lambda[0] (t)))), lwd=2, col=c("Black","Red"))
```

-   Comments on plots

    -   Baseline hazard can follow any functional form. This is the "non-parametric" part of the Cox proportional hazards model

    -   The cumulative hazard is a non-decreasing function that starts at 0 at time 0. It is bounded by $\infty$.

    -   Survival is a function of the cumulative hazard. Survival is 1 at time 0 and decreases over time. It is bounded by $0$ and $1$.

    -   For a dichotomous predictor variable (X is 0 or 1), the proportional hazards assumption is that $\lambda_1 (t) = e^{\beta_1} \lambda_0 (t)$

        -   In the plots I illustrated $e^{\beta_1} = 1.5$ ($\beta_1 = 0.4054$).

        -   On the hazard scale, this corresponds to $\lambda_1(t)$ always being $1.5$ times larger than $\lambda_0(t)$.

        -   On the log hazard scale, this corresponds to $log(\lambda_1(t))$ always being $log(1.5) = 0.4054$ units larger than $log(\lambda_0(t))$.

        -   The proportional hazards assumption is the "parametric" part of the Cox proportional hazards model. Hence, the Cox proportional hazards model is referred to as being "semi-parametric".

### Software

-   Stata commands

    -   "stset time event-indicator"

    -   "stcox predictor, \[robust\]"

-   R functions

    -   "Surv(time, event-indicator)"

    -   "coxph(Surv(time, event-indicator) \~ predictor)"

    -   There is a robust option in coxph for calcluating robust standard error estimates. In my opinion the assumption of proportional hazards in the Cox model rarely (never?) holds completely, so the robust option can be a good default.

    -   Lin, D. Y., and L. J. Wei. "The Robust Inference for the Cox Proportional Hazards Model." Journal of the American Statistical Association 84, no. 408 (1989): 1074--78. https://doi.org/10.2307/2290085.

### Example Analysis

#### Descriptives

-   Prognostic values of nadir PSA relative to time in remission

    -   PSA dataset: 50 men who received hormonal treatment for advanced prostate cancer

    -   Followed at least 24 months for clinical progression, but exact followup varies from subject to subject

    -   Nadir PSA: lowest level of serum prostate specific antigen achieved post treatment

-   Scatterplots of censored data are not scientifically meaningful

    -   It is best to not generate them unless you do something to indicate the censored dataset

    -   We can label censored data, but have to remember that the true value may be anywhere larger than that

```{r}
library(foreign)
library(rms)
psa <- read.dta(file="data/psa.dta")
psa$nadirpsa <- psa$dirpsa

ggplot(psa, aes(y=obstime, x=nadirpsa, color=inrem)) + geom_point() + theme_bw()

```

-   Characterization of plot

    -   Outliers: Can't tell

    -   First order trends

        -   Downward trending slop

        -   No censoring at high nadir PSAs (high nadir PSA are all early events)

    -   Second order trend: Must be curvilinear (but how much?)

    -   Variability within groups: Highest variability within lowest PSA groups

#### Regression model

-   The usual coding of the outcome is survival is 1 for an event and 0 for a censored observation.

```{r}
# First, create an indicator variable for those who relapsed at any time point
psa$relapse <- as.numeric(psa$inrem=="no")
with(psa, table(relapse, inrem))
```

-   Create a relapse variable to indicate if a subject has relapsed or not

-   Define the outcome using "Surv(obstime, relapse)"

    -   obstime: Time to event (either time to relapse or time to censored)

    -   relapse: Failure indicator variable

```{r}
m1 <- coxph(Surv(obstime, relapse) ~ nadirpsa, data=psa, robust=TRUE)
m1
summary(m1)
exp(confint.default(m1))

# 10-unit change in nadir PSA
exp(coef(m1)*10)

exp(10*confint.default(m1))

```

#### Interpretation of output

-   By default, R gives the hazard ratio and the coefficient for comparing groups who differ by one unit in the nadir psa covariate

    -   $\textrm{Hazard ratio} = e^{\textrm{coeff}}$

-   $\textrm{Hazard ratio} = 1.015^{\Delta nadir}$

-   Estimated hazard ratio for two groups differing by 1 in nadir PSA is found by exponentiating the slope

    -   Groups 1 unit higher nadir PSA have instantaneous event rate $1.0157$ fold higher (1.6% higher)

    -   Groups 10 units higher nadir PSA have instantaneous event rate $1.015^{10} = 1.166$ fold higher (16.6% higher)

#### Robust standard errors

R allows for robust standard errors in the coxph function. Note that other functions for fitting Cox models in R may or may not have this functionality.

"From proportional hazards regression analysis, we estimate that for each 1 ng/ml unit difference in nadir PSA, this risk of relapse is $1.6\%$ higher in the group with the higher nadir PSA. This estimate is highly statistically significant ($p < 0.001$). A 95% CI suggests that this observation is not unusual if a group that has a 1 ng/ml higher nadir PSA might have risk of relapse that was anywhere from $0.9\%$ higher to $2.3\%$ higher than the group with lower nadir PSA."

### Inference with PH Regression

-   The ideas of Signal and Noise found in simple linear regression do not translate well to PH regression

    -   We do not tend to quantify an error distribution with PH regression

-   Valid statistical inference (CIs, p-values) about *associations* requires three general assumptions

    -   Assumptions about approximately Normal distributions for the parameter estimates

        -   Large N

            -   Need for either robust standard errors or classical regression

            -   Definition of large depends on the underlying probability distribution

    -   Assumptions about independence of observations

        -   Classical regression: Independence of all observation

        -   Robust standard errors: Correlated observations within identified clusters

    -   Assumptions about variance of observations within groups

        -   Classical regression: Mean-variance relationship for binary data

            -   Proportional hazards considers the hazard of event at every time

            -   Hence in order to satisfy this requirement, need proportional hazards and linearity of predictor

        -   Robust standard errors

            -   Allows unequal variance across groups

            -   Hence, do not need linearity of predictor or proportional hazards

-   Valid statistical inference (CIs, p-values) about *hazard of response in specific groups* requires a further assumption

    -   Assumption about the adequacy of the linear model

        -   If we are trying to borrow information about the log hazards from neighboring groups, and we are assuming a straight line relationship, the straight line needs to be true

        -   Needed for either classical or robust standard errors

        -   Note that we can model transformations of the measured predictor

-   We rarely make inference about within group survival probabilities using the proportional hazards model

    -   Sometimes estimated survival curves are used descriptively

        -   Use estimates of the baseline survival function

        -   Exponentiate the baseline survival to find survival curve for specific covariate patterns

-   Relationship to survival

    -   Hazard function determines the survival function.

    -   For the Cox model

        |                   |                                                                                              |
        |:-------------------------|:---------------------------------------------|
        | Hazard            | $\lambda(t | X_i) = \lambda_{0}(t) \times e^{\beta_1 \times X_i}$                            |
        | Cumulative Hazard | $\Lambda(t | X_i) = \displaystyle\int^t_0 \lambda_{0}(u) \times e^{\beta_1 \times X_i} \ du$ |
        | Survival Function | $S(t | X_i) = e^{-\Lambda(t|X_i)} = [S_0(t)]^{e^{\beta_1 \times X_i}}$                       |

#### Log-transformed nadir PSA

-   Suppose that you know based on prior experience or consultation with collaborators...

    -   A constant difference in PSA would not be expected to confer the same increased risk

        -   Comparing 4 ng/ml to 10 ng/ml is not the same as comparing 104 ng/ml to 110 ng/ml

    -   A multiplicative effect on risk might be better

        -   Same increase in risk for each doubling of nadir PSA

        -   Achieve this model by using log transformed nadir PSA

```{r}
psa$lognadirpsa <- log(psa$nadirpsa)
m2 <- coxph(Surv(obstime, relapse) ~ lognadirpsa, data=psa, robust=TRUE)
m2
summary(m2)
exp(confint.default(m2))
```

-   Hazard ratio is $1.55$ for a $e$-fold difference in nadir PSA ($e = 2.7183$)

-   It is more easy to understand doubling, tripling, 5-fold, 10-fold increases

    -   For doubling: $\textrm{HR} = 1.54^{log(2)} = 1.35$

    -   For 5-fold: $\textrm{HR} = 1.54^{log(5)} = 1.99$

    -   Can similarly transform the upper and lower limits of the confidence interval

-   The confidence interval and statistical test given in the output is called a Wald test. Other tests (Score, Likelihood Ratio) are also possible.

    -   All tests are asymptotically equivalent

    -   The Wald test is easiest to obtain, but generally performs the poorest in small sample sizes. It is based on the coefficient estimate and standard error.

    -   The Likelihood Ratio test performs the best in small samples. We will discuss it later, including how to obtain the test using post-estimation commands.

    -   The Score test is not bad in small samples, but is often hard to obtain from software. It is exactly equal to the logrank test for binary outcomes and categorical predictors.

### Review: Interpretation of Slopes

#### Additive models

-   Identity link function

::: center
| Parameter | Approach          |
|:----------|:------------------|
| Means     | Linear regression |
:::

-   Interpretation of non-transformed slope: $\theta_X = \beta_0 + \beta_1 \times X$

    -   $\beta_1$ : (Average) difference in summary measure between groups per 1 unit difference in $X$

    -   $\Delta \times \beta_1$ : (Average) difference in summary measure between groups per $\Delta$ unit difference in $X$

-   Interpretation with log transformed slope: $\theta_X = \beta_0 + \beta_1 \times \textrm{log}(X)$

    -   $\textrm{log}(k) \times \beta_1$ : (Average) difference in summary measure between groups per $k$-fold difference in $X$

#### Multiplicative models

-   Log link function

::: center
| Parameter       | Approach                              |
|:----------------|:--------------------------------------|
| Geometric means | Linear regression on log scale        |
| Odds            | Logistic regression                   |
| Rates           | Poisson regression                    |
| Hazards         | Proportional Hazards (Cox) regression |
:::

-   Interpretation of non-transformed slope: $\textrm{log}(\theta_X) = \beta_0 + \beta_1 \times X$

    -   $e^{\beta_1}$ : (Average) ratio of summary measure between groups per 1 unit difference in $X$

    -   $e^{\Delta \times \beta_1}$ : (Average) ratio of summary measure between groups per $\Delta$ unit difference in $X$

-   Interpretation with log transformed slope: $\textrm{log}(\theta_X) = \beta_0 + \beta_1 \times \textrm{log}(X)$

    -   $e^{\textrm{log}(k) \times \beta_1} = k^{\beta_1}$ : (Average) ratio of summary measure between groups per $k$-fold difference in $X$

## Parametric regression

-   Fully-parametric models are less common than the semi-parametric Cox model because they are less flexible

-   However, if they are a good fit to a particular dataset, they may

    -   Estimate fewer parameters

    -   Allow for better predictions (as long as the error distribution is correctly specified!)

    -   Allow for comparison of survival estimates rather than hazards (accelerated failure time)

-   Two fundamental models used to describe the way that some factor might affect time to event

    -   Proportional hazards (aka Cox model)

    -   Accelerated failure time (less popular)

-   Accelerated Failure Time model

    -   Comparisons across groups based on survival times rather than hazards

    -   Assume that a factor causes some subjects to spend their lifetime too fast

    -   Basic idea: For every year in a reference group's lives, the other group ages "k" years

        -   e.g. 1 human year is about 7 dog years, so a 70 year old human is the same age as a 10 year old dog

        -   In AFT terminology, the probability that a human survives beyond 70 years is the same as the probability that a dog survives beyond 10 years

        -   From the framework, dogs are accelerating through life 7 times faster than a human. Equivalently, the lifespan of a human is stretched out to be 7 times longer than that of a dog.

    -   Assumes that ratios of quantiles of survival distribution are constant across groups

        -   e.g. report median ratios: It takes 50% longer for half of the treated group to die than half of the control group

    -   AFT models include the parametric exponential, Weibull, and lognormal models

### Weibull model

-   The Weibull model can also be interpreted as either a proportional hazard or accelerated failure time model. It is one of the few models that makes both the proportional hazards and accelerated failure time assumptions.

-   The Weibull model accommodates monotonically increasing or decreasing hazards

-   The following gives the relationship between the hazard function, Survival function, distribution function and cumulative distribution function for four different shape parameters following a Weibull distribution with scale parameter held constant at 2

```{r}
plot.data <- expand.grid(
  t = seq(0.1, 10, .1),
  loc = c(.5, 1, 1.5, 2)
) %>% 
  mutate(
    `F (CDF)` = pweibull(t, shape = loc, scale = 2),
    `f (PDF)` = dweibull(t, shape = loc, scale = 2),
    S = 1 - `F (CDF)`,
    `h = f / S` = flexsurv::hweibull(t, shape = loc, scale = 2),
    loc = paste("shape:", loc)
)

plot.data <- expand.grid(t=seq(0.1, 10, .1),
                         loc=c(.5, 1, 1.5, 2))

plot.data2 <- with(plot.data, 
                   data.frame(t=rep(t,4),
                              loc=rep(loc,4),
                              value=NA,
                              type=rep(1:4,each=nrow(plot.data))))

plot.data2$value[plot.data2$type==1] <- 
  pweibull(plot.data2$t[plot.data2$type==1], shape = plot.data2$loc[plot.data2$type==1], scale = 2)

plot.data2$value[plot.data2$type==2] <- 
  dweibull(plot.data2$t[plot.data2$type==2], shape = plot.data2$loc[plot.data2$type==2], scale = 2)

plot.data2$value[plot.data2$type==3] <- 
  1-pweibull(plot.data2$t[plot.data2$type==3], shape = plot.data2$loc[plot.data2$type==3], scale = 2)

plot.data2$value[plot.data2$type==4] <- 
  flexsurv::hweibull(plot.data2$t[plot.data2$type==4], shape = plot.data2$loc[plot.data2$type==4], scale = 2)

plot.data2$type <- factor(plot.data2$type, levels=1:4, labels=c("F (CDF)","f (PDF)", "S = 1 - F", "h = f / S" ))

plot.data2$loc2 <- paste("shape =", plot.data2$loc)

ggplot(plot.data2, aes(x=t, y=value)) + geom_line() + facet_grid(type ~ loc2, scales="free_y") + theme_bw()
```

-   Weibull hazard and cumulative hazard at time $t$ with shape $p$ and scale $\lambda$ $(\lambda > 0)$

$$h(t) = λpt^{(p−1)}$$

-   $p$ is a shape parameter

    -   $p>1$ is an increasing hazard over time

    -   $p=1$ is a constant hazard

    -   $p<1$ is a decreasing hazard

-   We can model the scale as a function of covariates

$$\textrm{where } \lambda = \textrm{exp}(\beta_0 + \beta_1 X_1 + \ldots + \beta_p X_p)$$

-   A special case of the Weibull model is the Exponential model. The Weibull reduces to the Exponential when the shape parameter is 1 ($p=1$). A shape parameter of 1 assumes the hazard is constant over time, and the cumulative hazard increases linearly with time.

    -   This provides a method for checking if the Weibull can be reduced to an Exponential model. If we estimate the cumulative hazard without making parametric assumptions and plot versus time, we can see if it is increasing at a constant rate.

-   Nelson-Aalen estimator of the cumulative hazard (non-parametric)

$$\hat{H}(t)=\sum_{i:t_i\leq t}\frac{d_i}{n_i}$$

-   where $d_i$ is the number of events at time $t_i$, and $n_i$ is the number of individuals at risk just before time $t_i$

-   Apply this to the lung cancer dataset

```{r}
# Calculate the non-parametric estimate of the cumulative hazard
n.risk <- summary(s1)$n.risk
n.evt <- summary(s1)$n.event
time <- summary(s1)$time

# Plot cumulative hazard versus time
na.haz <- n.risk/n.evt
na.cumhaz <- cumsum(na.haz)
plot(time, na.cumhaz)
```

-   Cumulative hazard is increasing over time, but not at a constant rate. The Weibull may be appropriate, but the Exponential is not appropriate.

### Weibull example

#### Compare fit of Weibull (parametric) to Kaplan-Meier (non-parametric)

-   Is the Weibull model a reasonable fit to the observed survival estimates?

```{r}
fit2 <- survreg(Surv(time, status) ~ sex, data = lung, dist = "weibull")

pct <- 1:98/100
ptime1 <- predict(fit2, newdata=data.frame(sex=1), type='quantile',
                 p=pct)
ptime2 <- predict(fit2, newdata=data.frame(sex=2), type='quantile',
                 p=pct)

# Kaplan-Meier fit
plot(fit.sex, col=1:2, ylab="Survival")

lines(ptime1, 1-pct, col=1,lty=2)
lines(ptime2, 1-pct, col=2,lty=2)
legend("topright", col=c(1,1,2,2), lty=c(1,2,1,2), 
       c("Kaplan-Meier, Male","Weibull, Male","Kaplan-Meier, Female","Weibull, Female"))
```

#### Interpretation of Weibull parameters

-   The Weibull model is both a proportional hazards and accelerated failure time model

-   How the model is parameterized will either give a proportional hazards or accelerated failure time interpretation

    -   For the Weibull proportional hazards model with one covariate ($X$)

        $$
        h(t) = \lambda p t^{p-1}
        $$

        $$
        \lambda = \textrm{exp}(\beta_0 + \beta_1 X)
        $$

    -   For the Weibull accelerated failure time model with one covariate ($X$)

        $$
        S(t) = exp(-\lambda t^p)
        $$

        Solve for $t$

        $$
        t = (-\textrm{ln} S(t))^{1/p} \times \frac{1}{\lambda^{1/p}}
        $$

        $$
        \frac{1}{\lambda^{1/p}} = \textrm{exp}(\alpha_0 + \alpha_1 X)
        $$

-   R default is to give the proportional hazards parameterization. The hazard ratio is found by exponentiation of the slope as we have done with other models

-   Compare to females, males are at a 1.48 fold increased risk (hazard) of death.

```{r}
summary(fit2)
exp(coef(fit2))
exp(confint.default(fit2))
```

-   To obtain the accelerated failure time interpretation, the Weibull model needs to be reparameterized so the output coefficients can be directly interpreted. We also have to exponeniate the coefficient estimates as we are comparing fold differences in survival quantiles.

```{r}
m.aft <- aftreg(formula = Surv(time, status) ~ sex, data = lung,
                         dist = "weibull")
m.aft
exp(confint(m.aft))
```

-   Acceleration factor (males compared to females) is 0.673

    -   Comparison of survival times, with males having shorter survival times at all percentiles

```{r}
# 25th, 50th, and 75th percentiles of survival time in males
ptime1[pct%in%c("0.25","0.5","0.75")]

# 25th, 50th, and 75th percentiles of survival time in females
ptime2[pct%in%c("0.25","0.5","0.75")]

# Ratios is constant (accelerated failure-time assumption)
ptime1[pct%in%c("0.25","0.5","0.75")] / ptime2[pct%in%c("0.25","0.5","0.75")]
```

-   Summary interpretation of both PH and AFT

From the Weibull regression model, we can estimate both the hazard ratio and acceleration factor.

Comparing males to females, males have a 1.48 fold increased hazard (risk) of death compared to females. We are 95% confident the true hazard ratio is between a 1.16 and 1.91 fold increase. Since the hazard ratio does not contain 1, males are at a significantly increased hazard of death compared to females.

Comparing males to females, males have a median (or any other quantile) survival times that is 0.673 times the median (or other quantile) survival time in females. We are 95% confident that the true acceleration factor is between 0.52 and 0.85.

The statements are more awkward when the acceleration factor is less than 1. We could flip the estimates (e.g $0.673^{-1}$) and say that the median (or other quantile) survival time in females is 1.49 times longer than it is in males to be less awkward.

-   Note that a hazard ratio greater than one is harmful for survival while an acceleration factor greater than one is beneficial for survival. One is the null values for both interpretations.

### Other parametric models

-   Example shown here focused on a Weibull model as an introduction. We identified the Exponential distribution (a special case of the Weibull) is not a good fit.

-   Other (parametric) distributions are possible. Some have a proportional hazards interpretation (only) or an accelerated failure time interpretation (only). Other lack either of these interpretations, but are more flexible in how they model the hazard function. There is a trade-off between interpretability and flexibility.

-   Goal is to pick a distribution with a corresponding hazard (cumulative hazard) that is appropriate model for your data, will be reproducible, and is ultimately interpretable.

-   Cox model is a good choice if you want to model associations and not concern yourself with the shape of the hazard function. This is a very common situation and why the Cox model is widely used.

-   If goal is prediction, appropriate parametric models (perhaps with additional flexibility) may outperform the Cox model


## Bayesian Time to Event Models


-   Bayesian approaches to fitting survival models are often based on parametric approaches or approaches that attempt to mimic the Cox model

    -   It is relatively straight forward to fit Bayesian models using parametric distributions like Weibull

    -   Models that attempt to recreate a Cox-like models are more complex because it can be difficult to recreate the flexibility of the baseline hazard function needed
    
    
### Review: Bayesian Analysis

* The Bayesian Paradigm provides a framework for incorporating prior knowledge with observed data through the use of probability models. In this approach:

-   **Posterior distribution** is obtained by combining:
    1.  The **Likelihood**: $L(\mathbf{\theta}; \mathbf{x})$, representing the probability of the observed data $\mathbf{x}$ given the model parameters $\mathbf{\theta}$.
    2.  The **Prior Distribution**: $\pi(\mathbf{\theta})$, reflecting prior beliefs or information about $\mathbf{\theta}$.

* Mathematically, the posterior distribution is expressed as:

$$
p(\mathbf{\theta} \mid \text{data}) \propto L(\mathbf{\theta}; \mathbf{x}) \cdot \pi(\mathbf{\theta})
$$

* This illustrates the key Bayesian principle: beliefs about $\mathbf{\theta}$ (the **posterior distribution**) are updated by combining new evidence (the **likelihood**) with prior knowledge (the **prior distribution**).

### Review: Linear Regression

* The Bayesian paradigm can be applied to the linear regression model, where the parameters of interest, $\boldsymbol{\theta} = (\boldsymbol{\beta}, \sigma)$, consist of:

   -   $\boldsymbol{\beta}$: The regression coefficients (bold to emphasize their vector nature).
   -   $\sigma$: The standard deviation of the residuals, representing the variability not explained by the model.

#### Likelihood

* In classical linear regression, the **Likelihood** $L(\boldsymbol{\theta}; \mathbf{x})$ is modeled as a Normal distribution with mean $\mathbf{X} \boldsymbol{\beta}$ and variance $\sigma^2$, where $\mathbf{X}$ is the design matrix of predictors.

* The likelihood can be expressed as a product of individual likelihoods for each data point $i$, given by:

$$
L(\boldsymbol{\theta}; \mathbf{x}) = \prod_{i=1}^n L_i(\boldsymbol{\theta}; \mathbf{x}_i)
$$

* For classical linear regression (assuming a Normal distribution) this becomes:

$$
L(\boldsymbol{\theta}; \mathbf{y}, \mathbf{X}) = \prod_{i=1}^n \frac{1}{\sqrt{2 \pi \sigma^2}} \exp \left( -\frac{(y_i - \mathbf{x}_i^\top \boldsymbol{\beta})^2}{2 \sigma^2} \right)
$$

-   $y_i$: Observed outcome for the $i$-th data point
-   $\mathbf{x}_i^T$: Row vector of predictors for the $i$-th data point.
-   $\boldsymbol{\beta}$: Coefficients for the predictors
-   $\sigma^2$: Variance of the residuals.

#### Prior Distributions

In the Bayesian framework, prior distributions are assigned to the parameters of interest to reflect prior beliefs or knowledge about their values before observing the data. For Bayesian linear regression, typical priors (but not the only priors) include:

-   **For** $\boldsymbol{\beta}$: A multivariate Normal distribution: $$
    \pi(\boldsymbol{\beta}) \sim \mathcal{N}(\boldsymbol{\mu}_\beta, \mathbf{\Sigma}_\beta)
    $$ where $\boldsymbol{\mu}_\beta$ is the mean vector and $\mathbf{\Sigma}_\beta$ is the covariance matrix, encoding the prior beliefs about $\boldsymbol{\beta}$.

-   **For** $\sigma$: An exponential distribution: $$
    \pi(\sigma) \sim \text{Exponential}(\lambda)
    $$ where $\lambda$ is a rate parameter. In **rstanarm** and **stan_glm**, $\lambda$ is weakly informative and scaled based on the data, often reflecting the standard deviation of the outcome variable.

#### Posterior distribution

* These priors, combined with the likelihood, form the basis for the posterior distribution, which is proportional to the product of the likelihood and the priors.

* This model encodes several key assumptions:

   1 **Linearity**: The relationship between the predictors and the outcome is linear, expressed as the expected value $\mathbb{E}[Y] = \mathbf{X} \boldsymbol{\beta}$.

   2 **Homoskedasticity**: The variance of the residuals $\text{Var}(\varepsilon_i) = \sigma^2$ is constant across all levels of the predictors.

   3 **Normality of the residuals**: $\epsilon_i \sim N(0, \sigma^2)$

### Review: Logistic Regression

* The Bayesian Paradigm can be applied to the logistic regression model, where the parameters of interest are $\boldsymbol{\theta} = \boldsymbol{\beta}$,

* In logistic regression, the Bayesian approach models the probability of a binary outcome $y_i \in \{0, 1\}$ as a function of the predictors $\mathbf{x}_i$ and the regression coefficients $\boldsymbol{\beta}$. The likelihood for the observed data is expressed as:

$$
L(\boldsymbol{\beta}; \mathbf{y}, \mathbf{X}) = \prod_{i=1}^n \left( \pi_i \right)^{y_i} \left( 1 - \pi_i \right)^{1 - y_i}
$$


* $\pi_i = \text{logit}^{-1}(\mathbf{x}_i^\top \boldsymbol{\beta}) = \frac{\exp(\mathbf{x}_i^\top \boldsymbol{\beta})}{1 + \exp(\mathbf{x}_i^\top \boldsymbol{\beta})}$
* $y_i$: Observed binary outcome for the $i$-th data point.
* $\mathbf{x}_i^\top$: Row vector of predictors for the $i$-th data point. 
* $\boldsymbol{\beta}$: Regression coefficients.

This likelihood serves as the basis for updating the posterior distribution when combined with appropriate prior distributions on $\boldsymbol{\beta}$.


* See [Logistic Regression Notes](Lec04.Logistic.qmd#sec-bayeslogistic) for additional details


### Bayesian Parametric Survival Analysis


* The Bayesian approach to parametric survival models follow a similar procedure to linear and logistic regression

   * A likelihood is specified based on the assumed underlying probability distribution
   
   
   * Prior distributions are specified for the parameters in the model
   
   * The posterior distribution is updated combining the likelihood and the prior


#### Example: Weibull model, Bayesian approach

* Suppose we assume a Weibull distribution for survival time.  The parameters of interest, $\boldsymbol{\theta}$, typically include:

   * $\boldsymbol{\beta}$: Regression coefficients for covariates (bold to emphasize their vector nature) to impact the scale parameter of the Weibull distribution

   * $p$: Shape parameter of the Weibull distribution.

The likelihood for the observed survival data $(t_i, \delta_i)$ is expressed as:

$$
L(\boldsymbol{\theta}; \mathbf{t}, \boldsymbol{\delta}) = \prod_{i=1}^n \left[h(t_i; \lambda, p)^{\delta_i} \cdot S(t_i; \lambda, p)^{1 - \delta_i}\right],
$$

where:

* $t_i$: Survival time for the $i$-th individual.

* $\delta_i$: Censoring indicator, where $\delta_i = 1$ if the event is observed and $\delta_i = 0$ if the data is censored.

* $\mathbf{t}$ and $\boldsymbol{\delta}$: Vectors of survival times and censoring indicators.

* $\lambda = \exp(\mathbf{X}\boldsymbol{\beta})$: Scale parameter is modeled as a function of covariates

#### Prior Distributions

* In the Bayesian framework, prior distributions are assigned to the model parameters:
- **For $\boldsymbol{\beta}$**: A multivariate Normal distribution:
  $$
  \pi(\boldsymbol{\beta}) \sim \mathcal{N}(\boldsymbol{\mu}_\beta, \mathbf{\Sigma}_\beta),
  $$
  where $\boldsymbol{\mu}_\beta$ is the mean vector and $\mathbf{\Sigma}_\beta$ is the covariance matrix.
  
- **For $p$**: Weakly informative prior, such as Gamma distributions or other appropriate priors based on prior knowledge.

* These priors combined with the likelihood provide the posterior distribution used for inference.


### Bayesian Cox-type Models for Time to Event Data

- There is no direct analog of the Cox model in the Bayesian paradigm.  The reason for this relates to the partial likelihood.

- Cox models are estimated by maximizing the partial likelihood, which does not include the baseline hazard function

The partial likelihood for the Cox model is given by:

$$
L_p(\boldsymbol{\beta}) = \prod_{i:\delta_i=1} h_0(t_i) \exp(\mathbf{x}_i^\top \boldsymbol{\beta}) \Bigg/ \sum_{j \in R(t_i)} h_0(t_i) \exp(\mathbf{x}_j^\top \boldsymbol{\beta}),
$$

where:

* $h_0(t_i)$: Baseline hazard function at time $t_i$.

* $\boldsymbol{\beta}$: Regression coefficients.

* $\mathbf{x}_i$: Covariates for the $i$-th individual.

* $R(t_i)$: Risk set at time $t_i$, i.e., individuals still at risk just before time $t_i$.

The baseline hazard cancels out, so the partial likelihood simplifies to:

$$
L_p(\boldsymbol{\beta}) = \prod_{i:\delta_i=1} \frac{\exp(\mathbf{x}_i^\top \boldsymbol{\beta})}{\sum_{j \in R(t_i)} \exp(\mathbf{x}_j^\top \boldsymbol{\beta})}.
$$

* Key point: In a frequentist analysis, $\beta$ is maximized irrespective of the baseline hazard

* In a Bayesian analysis, the unspecified baseline hazard function $h_0(t)$ cannot be ignored.  An additional approach is required to estimate the baseline hazard alongside $\boldsymbol{\beta}$. 

* Methods often involve modeling the baseline hazard explicitly, such as using splines or piecewise constant functions.  Alternatively, latent processes can allow flexible modeling and full Bayesian inference.

   1. **Piecewise Exponential Model**: The time axis is divided into predefined intervals, and the baseline hazard is assumed to be constant within each interval. This approach offers flexibility while maintaining computational simplicity.

```{r}
#| label: fig-piecewise-exponential
#| fig-cap: "Piecewise Exponential Hazard Function"
library(ggplot2)

plot_data <- data.frame(
  from_time = seq(0, 4, by = 1),
  to_time = seq(1, 5, by = 1),
  hazard = c(0.5, 1, 1.5, 0.8, 0.3)
)
ggplot(plot_data) + geom_segment(aes(x = from_time, xend = to_time, y = hazard, yend = hazard))  +
  labs(
    x = "Time",
    y = "Hazard"
  ) +
  theme_minimal() + 
  ylim(0,1.6)
```


   2. **Spline-Based Methods**: The baseline hazard is modeled using splines, such as cubic splines or B-splines, allowing for a smooth and flexible representation of the hazard function over time.

```{r}
#| label: fig-spline-hazard
#| fig-cap: "Spline-Based Hazard Function"

# Load necessary libraries
library(ggplot2)
library(splines)

# Define time points and a base positive hazard function (example)
time_points <- seq(0, 5, length.out = 100)
base_hazard <- abs(0.5 + 0.3 * time_points - 0.1 * time_points^2)  # Ensure hazards are positive
noise <- abs(rnorm(length(time_points), mean = 0, sd = 0.05))  # Add positive noise
hazard_values <- base_hazard + noise

# Fit a cubic spline to the hazard function
spline_fit <- smooth.spline(time_points, hazard_values)

# Create data for plotting the spline
spline_data <- data.frame(
  time = spline_fit$x,
  hazard = spline_fit$y
)

# Plot the spline-based hazard function
ggplot(data = spline_data, aes(x = time, y = hazard)) +
  geom_line(color = "blue", size = 1) +
  labs(
    x = "Time",
    y = "Hazard"
  ) +
  theme_minimal() +
  ylim(0, NA)  # Set y-axis lower bound to 0
```


   3. **Dirichlet Process Priors**: The baseline hazard is modeled nonparametrically using a Dirichlet process prior. This approach provides flexibility in estimating the hazard function by letting the data inform its shape, while still incorporating prior beliefs.

   4. **Others**: Machine learning and other approaches


### R-Related Software for Bayesian Survival Analysis

There are several R packages that support Bayesian survival analysis.

- **`stan_surv` in `rstanarm`**:

   * This function implements Bayesian survival analysis using flexible parametric models. It can handle a variety of survival models, including those with user-specified baseline hazard functions
   
   * It is currently (March, 2025) available in the development version of `rstanarm`, so I am not demonstrating it.
   
   *  [Estimating Survival (Time-to-Event) Models with rstanarm](https://stan-dev.r-universe.dev/articles/rstanarm/surv.html)


- **`brms`**

   * The `brms` package allows for Bayesian survival models using flexible formula syntax
   
   * Supports parametric survival distributions and can be used to specify custom hazard models.
   
   * [Bayesian Regression Models using STAN](https://paul-buerkner.github.io/brms/)
   
* Both packages are use-friendly front ends for [Stan: Software for Bayesian Analysis](https://mc-stan.org/)


